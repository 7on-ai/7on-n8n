{
  "nodes": [
    {
      "parameters": {
        "content": "# WF5-B ‚Äî Gating Queue v2 (Inline)\n\n### Flow:\n1. Webhook ‡∏£‡∏±‡∏ö payload ‡∏à‡∏≤‡∏Å WF2 (respond immediately)\n2. Validate: userId, text ‚â• 10 chars, dbUrl\n3. **Process Gating (inline):**\n   - Embed via OpenAI text-embedding-3-small (user key)\n   - Classify via OpenRouter Haiku (structured JSON)\n   - Keyword fallback (Thai/EN)\n   - Save: memory_embeddings + interaction_memories + ethical_profiles\n4. Log: heartbeat_log + User.persona.ethical_summary\n5. Detect needs_support ‚Üí emit alert to WF-Heartbeat\n\n### ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ:\n- ‚ùå Gating Service (Northflank)\n- ‚ùå Ollama shared service\n\n### DB Schema Change:\n```sql\n-- dim 768 ‚Üí 1536 (text-embedding-3-small)\nALTER TABLE user_data_schema.memory_embeddings\n  ALTER COLUMN embedding TYPE vector(1536);\n```\n\n### ENV Required:\n- DATABASE_URL\n- OPENROUTER_API_KEY (system-level classify fallback)\n- N8N_BASE_URL\n\n### User Keys (from WF2 Load Tokens):\n- metadata.openai_key ‚Üí embedding",
        "height": 520,
        "width": 420,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -368,
        -224
      ],
      "id": "8e80bf95-1ab2-4b36-980a-b8fa25ca4020",
      "name": "WF5-B Overview"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "wf5b-gating-queue",
        "responseMode": "immediately",
        "options": {}
      },
      "id": "9d841cbc-e9b2-4796-b5d7-2c1c4f14d510",
      "name": "Gating Queue Entry",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        32,
        400
      ],
      "webhookId": "wf5b-gating-queue-entry"
    },
    {
      "parameters": {
        "jsCode": "// Validate gating payload\nconst body = $input.first().json.body || $input.first().json;\n\nconst userId = body.user_id;\nconst text = (body.text || '').trim();\nconst databaseUrl = body.database_url || process.env.DATABASE_URL || '';\nconst metadata = body.metadata || {};\n\nif (!userId) {\n  return { json: { skip: true, reason: 'no_user_id' } };\n}\nif (!text || text.length < 10) {\n  return { json: { skip: true, reason: 'text_too_short', length: text.length } };\n}\nif (!databaseUrl) {\n  return { json: { skip: true, reason: 'no_database_url' } };\n}\n\nconsole.log(`[WF5-B] Received | userId=${userId.substring(0,8)}... | len=${text.length} | source=${metadata.source}`);\n\nreturn { json: { userId, text, databaseUrl, metadata, skip: false } };"
      },
      "id": "83dfda61-ab5c-4ecb-82cd-3910b00e9156",
      "name": "Validate & Guard",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        272,
        400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "46d1f83a-8b47-48d3-91e0-a0a8c6dc0ddd",
      "name": "Should Process?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        496,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// WF5-B: Process Gating ‚Äî Full Gating Logic (No External Service)\n// Replaces: Call Gating Service + Parse Gating Result\n// Uses: OpenAI embedding (user key) + OpenRouter Haiku (classify)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst item = $input.first().json;\nconst { userId, text, databaseUrl, metadata } = item;\n\nconst openaiKey = metadata?.openai_key || process.env.OPENAI_API_KEY || '';\nconst openrouterKey = process.env.OPENROUTER_API_KEY || '';\nconst dbUrl = databaseUrl || process.env.DATABASE_URL || '';\n\n// ‚îÄ‚îÄ 1. Detect Language ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nfunction detectLanguage(t) {\n  if (/[\\u0E00-\\u0E7F]/.test(t)) return 'th';\n  if (/[\\u4E00-\\u9FFF]/.test(t)) return 'zh';\n  if (/[\\u3040-\\u309F\\u30A0-\\u30FF]/.test(t)) return 'ja';\n  return 'en';\n}\n\n// ‚îÄ‚îÄ 2. Keyword Fallback Classification ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nfunction keywordClassify(t, lang) {\n  const tl = t.toLowerCase();\n  const kw = {\n    th: {\n      growth:    ['‡∏£‡∏±‡∏Å','‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì','‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ','‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏î‡∏µ‡πÉ‡∏à','‡∏™‡∏∏‡∏Ç','‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à','‡∏û‡∏±‡∏í‡∏ô‡∏≤','‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï','‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤','‡∏ó‡∏≥‡πÑ‡∏î‡πâ'],\n      challenge: ['‡πÇ‡∏Å‡∏£‡∏ò','‡πÄ‡∏Å‡∏•‡∏µ‡∏¢‡∏î','‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î','‡∏ú‡∏¥‡∏î‡∏´‡∏ß‡∏±‡∏á','‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à','‡πÄ‡∏´‡∏á‡∏≤','‡∏ó‡πâ‡∏≠‡πÅ‡∏ó‡πâ','‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß','‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞'],\n      wisdom:    ['‡∏õ‡∏±‡∏ç‡∏ç‡∏≤','‡∏™‡∏ï‡∏¥','‡∏™‡∏°‡∏≤‡∏ò‡∏¥','‡∏ò‡∏£‡∏£‡∏°‡∏∞','‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö','‡∏™‡∏á‡∏ö'],\n      crisis:    ['‡∏≠‡∏¢‡∏≤‡∏Å‡∏ï‡∏≤‡∏¢','‡∏Ü‡πà‡∏≤‡∏ï‡∏±‡∏ß','‡∏™‡∏¥‡πâ‡∏ô‡∏´‡∏ß‡∏±‡∏á','‡∏ó‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß','‡∏´‡∏°‡∏î‡πÅ‡∏£‡∏á']\n    },\n    en: {\n      growth:    ['love','thank','grateful','happy','joy','proud','success','learn','improve','achieve'],\n      challenge: ['angry','hate','stress','sad','lonely','discourage','fail','lost','argue','hurt'],\n      wisdom:    ['wisdom','insight','meditation','truth','awareness','accept','peaceful'],\n      crisis:    ['want to die','kill myself','hopeless','cant go on','give up on life']\n    }\n  };\n  const k = kw[lang] || kw['en'];\n  if (k.crisis.some(w => tl.includes(w)))    return 'needs_support';\n  if (k.challenge.some(w => tl.includes(w))) return 'challenge_memory';\n  if (k.wisdom.some(w => tl.includes(w)))    return 'wisdom_moment';\n  if (k.growth.some(w => tl.includes(w)))    return 'growth_memory';\n  return 'neutral_interaction';\n}\n\n// ‚îÄ‚îÄ 3. Default Ethical Scores ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nfunction defaultScores(cls) {\n  const map = {\n    growth_memory:       { self_awareness:0.7, emotional_regulation:0.7, compassion:0.7, integrity:0.6, growth_mindset:0.8, wisdom:0.6, transcendence:0.6 },\n    challenge_memory:    { self_awareness:0.4, emotional_regulation:0.3, compassion:0.5, integrity:0.5, growth_mindset:0.4, wisdom:0.4, transcendence:0.3 },\n    wisdom_moment:       { self_awareness:0.8, emotional_regulation:0.7, compassion:0.7, integrity:0.7, growth_mindset:0.7, wisdom:0.9, transcendence:0.8 },\n    needs_support:       { self_awareness:0.3, emotional_regulation:0.2, compassion:0.4, integrity:0.4, growth_mindset:0.3, wisdom:0.3, transcendence:0.2 },\n    neutral_interaction: { self_awareness:0.5, emotional_regulation:0.5, compassion:0.5, integrity:0.5, growth_mindset:0.5, wisdom:0.5, transcendence:0.4 }\n  };\n  return map[cls] || map['neutral_interaction'];\n}\n\n// ‚îÄ‚îÄ 4. Growth Stage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nfunction growthStage(scores) {\n  const avg = Object.values(scores).reduce((a,b) => a+b, 0) / Object.values(scores).length;\n  if (avg < 0.3) return 1;\n  if (avg < 0.5) return 2;\n  if (avg < 0.7) return 3;\n  if (avg < 0.85) return 4;\n  return 5;\n}\n\n// ‚îÄ‚îÄ 5. Detect Moments ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nfunction detectMoments(scores, cls) {\n  if (cls === 'needs_support') return [{ type:'crisis', severity:'critical', description:'User needs support' }];\n  if (['growth_memory','wisdom_moment'].includes(cls)) return [{ type:'growth', severity:'positive', description:'Positive development' }];\n  return [];\n}\n\n// ‚îÄ‚îÄ 6. i18n Guidance & Reflection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nfunction getGuidance(cls, lang) {\n  const m = {\n    growth_memory:       { en:'Wonderful progress! Keep nurturing this growth.', th:'‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏∞‡∏Ñ‡∏∞' },\n    challenge_memory:    { en:'I understand. Take it one step at a time.', th:'‡∏â‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à ‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞' },\n    wisdom_moment:       { en:'Beautiful insight. This wisdom will guide you.', th:'‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Ñ‡∏∏‡∏ì' },\n    needs_support:       { en:\"I'm here for you. Please reach out to someone you trust.\", th:'‡∏â‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏ß‡πâ‡πÉ‡∏à' },\n    neutral_interaction: { en:'Thank you for sharing.', th:'‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô' }\n  };\n  return (m[cls] || m['neutral_interaction'])[lang] || (m[cls] || m['neutral_interaction'])['en'];\n}\n\nfunction getReflection(cls, lang) {\n  const m = {\n    growth_memory:       { en:'What did you learn from this experience?', th:'‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏ö‡πâ‡∏≤‡∏á?' },\n    challenge_memory:    { en:'How can you grow from this challenge?', th:'‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?' },\n    wisdom_moment:       { en:'How will this insight change your perspective?', th:'‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏¥‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?' },\n    needs_support:       { en:'What support do you need right now?', th:'‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ?' },\n    neutral_interaction: { en:'What are you thinking about?', th:'‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà?' }\n  };\n  return (m[cls] || m['neutral_interaction'])[lang] || (m[cls] || m['neutral_interaction'])['en'];\n}\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// MAIN EXECUTION\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst lang = detectLanguage(text);\nconsole.log(`[WF5-B Process] userId=${userId.substring(0,8)}... | lang=${lang} | len=${text.length}`);\n\nlet embedding = null;\nlet classification = null;\nlet ethicalScores = null;\nlet reasoning = 'keyword_fallback';\n\n// ‚îÄ‚îÄ Step A: Generate Embedding (OpenAI) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nif (openaiKey) {\n  try {\n    const embedRes = await fetch('https://api.openai.com/v1/embeddings', {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${openaiKey}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        model: 'text-embedding-3-small',\n        input: text,\n        dimensions: 1536\n      })\n    });\n    if (embedRes.ok) {\n      const embedData = await embedRes.json();\n      embedding = embedData.data?.[0]?.embedding;\n      console.log(`[WF5-B] ‚úÖ Embedding generated | dim=${embedding?.length}`);\n    } else {\n      console.warn(`[WF5-B] ‚ö†Ô∏è OpenAI embed failed: ${embedRes.status}`);\n    }\n  } catch(e) {\n    console.warn(`[WF5-B] ‚ö†Ô∏è Embed error: ${e.message}`);\n  }\n} else {\n  console.warn('[WF5-B] No OpenAI key ‚Äî skipping embedding');\n}\n\n// ‚îÄ‚îÄ Step B: Classify (OpenRouter Haiku) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nif (openrouterKey) {\n  try {\n    const prompt = `Classify this text into ONE category for ethical growth tracking.\n\nText: \"${text}\"\nLanguage: ${lang.toUpperCase()}\n\nCategories:\n- growth_memory: Positive emotions, learning, achievement, gratitude\n- challenge_memory: Negative emotions, stress, conflict, disappointment  \n- wisdom_moment: Deep insights, philosophical reflection, self-awareness\n- needs_support: Crisis signals, severe distress, hopelessness\n- neutral_interaction: Casual conversation, commands, requests\n\nRespond ONLY with valid JSON (no markdown, no explanation):\n{\n  \"classification\": \"category_name\",\n  \"self_awareness\": 0.0-1.0,\n  \"emotional_regulation\": 0.0-1.0,\n  \"compassion\": 0.0-1.0,\n  \"integrity\": 0.0-1.0,\n  \"growth_mindset\": 0.0-1.0,\n  \"wisdom\": 0.0-1.0,\n  \"transcendence\": 0.0-1.0,\n  \"reasoning\": \"brief explanation\"\n}`;\n\n    const llmRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${openrouterKey}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        model: 'anthropic/claude-haiku-4-5',\n        messages: [{ role: 'user', content: prompt }],\n        max_tokens: 300,\n        temperature: 0.2\n      })\n    });\n\n    if (llmRes.ok) {\n      const llmData = await llmRes.json();\n      const raw = llmData.choices?.[0]?.message?.content || '';\n      const jsonMatch = raw.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        const parsed = JSON.parse(jsonMatch[0]);\n        const valid = ['growth_memory','challenge_memory','wisdom_moment','needs_support','neutral_interaction'];\n        if (valid.includes(parsed.classification)) {\n          classification = parsed.classification;\n          ethicalScores = {\n            self_awareness:       Math.min(1, Math.max(0, parsed.self_awareness || 0.5)),\n            emotional_regulation: Math.min(1, Math.max(0, parsed.emotional_regulation || 0.5)),\n            compassion:           Math.min(1, Math.max(0, parsed.compassion || 0.5)),\n            integrity:            Math.min(1, Math.max(0, parsed.integrity || 0.5)),\n            growth_mindset:       Math.min(1, Math.max(0, parsed.growth_mindset || 0.5)),\n            wisdom:               Math.min(1, Math.max(0, parsed.wisdom || 0.5)),\n            transcendence:        Math.min(1, Math.max(0, parsed.transcendence || 0.5))\n          };\n          reasoning = parsed.reasoning || 'openrouter_haiku';\n          console.log(`[WF5-B] ‚úÖ LLM classified: ${classification}`);\n        }\n      }\n    } else {\n      console.warn(`[WF5-B] ‚ö†Ô∏è OpenRouter failed: ${llmRes.status}`);\n    }\n  } catch(e) {\n    console.warn(`[WF5-B] ‚ö†Ô∏è LLM error: ${e.message}`);\n  }\n}\n\n// ‚îÄ‚îÄ Step C: Keyword Fallback ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nif (!classification) {\n  classification = keywordClassify(text, lang);\n  ethicalScores = defaultScores(classification);\n  reasoning = 'keyword_fallback';\n  console.log(`[WF5-B] ‚ö†Ô∏è Fallback classification: ${classification}`);\n}\n\n// ‚îÄ‚îÄ Step D: Derived values ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nconst stage = growthStage(ethicalScores);\nconst moments = detectMoments(ethicalScores, classification);\nconst reflectionPrompt = getReflection(classification, lang);\nconst gentleGuidance = getGuidance(classification, lang);\nconst needsAlert = classification === 'needs_support' || moments.some(m => m.type === 'crisis');\n\n// ‚îÄ‚îÄ Step E: Save to DB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nlet memoryId = null;\n\nif (dbUrl) {\n  try {\n    const { Pool } = require('pg');\n    const pool = new Pool({ connectionString: dbUrl });\n\n    // 5a. Save memory_embeddings (with or without vector)\n    if (embedding) {\n      const vectorStr = `[${embedding.join(',')}]`;\n      const embResult = await pool.query(\n        `INSERT INTO user_data_schema.memory_embeddings\n           (user_id, content, embedding, metadata, created_at)\n         VALUES ($1, $2, $3::vector, $4, NOW())\n         RETURNING id`,\n        [\n          userId, text, vectorStr,\n          JSON.stringify({ classification, language: lang, source: metadata?.source || 'wf5b' })\n        ]\n      );\n      memoryId = String(embResult.rows[0].id);\n      console.log(`[WF5-B] ‚úÖ Embedding saved | id=${memoryId}`);\n    } else {\n      // Save without embedding (text-only fallback)\n      const embResult = await pool.query(\n        `INSERT INTO user_data_schema.memory_embeddings\n           (user_id, content, metadata, created_at)\n         VALUES ($1, $2, $3, NOW())\n         RETURNING id`,\n        [\n          userId, text,\n          JSON.stringify({ classification, language: lang, no_embedding: true })\n        ]\n      );\n      memoryId = String(embResult.rows[0].id);\n    }\n\n    // 5b. Save interaction_memories\n    const weightMap = {\n      growth_memory: 1.5, challenge_memory: 2.0, wisdom_moment: 2.5,\n      neutral_interaction: 0.8, needs_support: 1.0\n    };\n    await pool.query(\n      `INSERT INTO user_data_schema.interaction_memories\n         (user_id, text, classification, ethical_scores, moments, reflection_prompt,\n          gentle_guidance, training_weight, approved_for_training, metadata, created_at)\n       VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,NOW())`,\n      [\n        userId, text, classification,\n        JSON.stringify(ethicalScores),\n        JSON.stringify(moments),\n        reflectionPrompt, gentleGuidance,\n        weightMap[classification] || 1.0,\n        classification !== 'needs_support',\n        JSON.stringify({ source: 'wf5b_inline', memory_embedding_id: memoryId })\n      ]\n    );\n\n    // 5c. Upsert ethical_profiles\n    await pool.query(\n      `INSERT INTO user_data_schema.ethical_profiles\n         (user_id, self_awareness, emotional_regulation, compassion, integrity,\n          growth_mindset, wisdom, transcendence, growth_stage, updated_at)\n       VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,NOW())\n       ON CONFLICT (user_id) DO UPDATE SET\n         self_awareness       = EXCLUDED.self_awareness,\n         emotional_regulation = EXCLUDED.emotional_regulation,\n         compassion           = EXCLUDED.compassion,\n         integrity            = EXCLUDED.integrity,\n         growth_mindset       = EXCLUDED.growth_mindset,\n         wisdom               = EXCLUDED.wisdom,\n         transcendence        = EXCLUDED.transcendence,\n         growth_stage         = EXCLUDED.growth_stage,\n         total_interactions   = ethical_profiles.total_interactions + 1,\n         updated_at           = NOW()`,\n      [\n        userId,\n        ethicalScores.self_awareness, ethicalScores.emotional_regulation,\n        ethicalScores.compassion, ethicalScores.integrity,\n        ethicalScores.growth_mindset, ethicalScores.wisdom,\n        ethicalScores.transcendence, stage\n      ]\n    );\n\n    await pool.end();\n    console.log(`[WF5-B] ‚úÖ DB saved | cls=${classification} | stage=${stage}`);\n\n  } catch(err) {\n    console.error(`[WF5-B] ‚ùå DB error: ${err.message}`);\n  }\n}\n\n// ‚îÄ‚îÄ Return same shape as old Gating Service response ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nreturn {\n  json: {\n    ...item,\n    gatingSuccess: true,\n    routing: classification,\n    ethicalScores,\n    growthStage: stage,\n    detectedLanguage: lang,\n    memoryId,\n    moments,\n    reflectionPrompt,\n    gentleGuidance,\n    needsAlert,\n    reasoning\n  }\n};"
      },
      "id": "1f9235a6-795a-400f-8c18-b6d1bb7c6493",
      "name": "Process Gating",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        720,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\nconst dbUrl = item.databaseUrl || process.env.DATABASE_URL || '';\n\nif (!dbUrl) {\n  console.log('[WF5-B Log] No DB URL, skipping log');\n  return { json: { ...item, logged: false } };\n}\n\ntry {\n  const { Pool } = require('pg');\n  const pool = new Pool({ connectionString: dbUrl });\n\n  // Log to heartbeat_log\n  await pool.query(\n    `INSERT INTO user_data_schema.heartbeat_log\n       (user_id, heartbeat_type, trigger_type, action, urgency, message_sent, delivered, channel, created_at)\n     VALUES ($1, $2, $3, $4, $5, $6, $7, $8, NOW())`,\n    [\n      item.userId,\n      'gating_' + (item.routing || 'unknown'),\n      item.metadata?.source || 'wf2',\n      item.gatingSuccess ? 'gated' : 'gating_failed',\n      item.needsAlert ? 'high' : 'low',\n      item.gatingSuccess\n        ? `routing=${item.routing}|stage=${item.growthStage}|memoryId=${item.memoryId}`\n        : item.gatingError || null,\n      true,\n      null\n    ]\n  );\n\n  // Update User.persona.ethical_summary\n  if (item.gatingSuccess) {\n    await pool.query(\n      `UPDATE \"User\"\n       SET persona = jsonb_set(\n         COALESCE(persona, '{}'::jsonb),\n         '{ethical_summary}',\n         $1::jsonb\n       ),\n       updated_at = NOW()\n       WHERE id = $2`,\n      [\n        JSON.stringify({\n          growth_stage: item.growthStage,\n          last_routing: item.routing,\n          last_gated_at: new Date().toISOString(),\n          detected_language: item.detectedLanguage\n        }),\n        item.userId\n      ]\n    );\n  }\n\n  await pool.end();\n  console.log(`[WF5-B Log] ‚úÖ Logged | routing=${item.routing}`);\n  return { json: { ...item, logged: true } };\n\n} catch(err) {\n  console.error('[WF5-B Log] DB error:', err.message);\n  return { json: { ...item, logged: false, logError: err.message } };\n}"
      },
      "id": "75126948-e6c0-4709-9141-1cb1c8d77e9c",
      "name": "Log to DB",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        944,
        240
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "leftValue": "={{ $json.needsAlert }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "3f80e632-5dfb-40f8-83e4-39d509ce3f86",
      "name": "Needs Support Alert?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1168,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\nconst n8nBase = process.env.N8N_BASE_URL || 'http://localhost:5678';\nconst heartbeatEventUrl = `${n8nBase}/webhook/wf-heartbeat-event`;\n\nconst eventPayload = {\n  eventType: 'needs_support',\n  userId: item.userId,\n  data: {\n    routing: item.routing,\n    ethical_scores: item.ethicalScores,\n    growth_stage: item.growthStage,\n    moments: item.moments,\n    gentle_guidance: item.gentleGuidance,\n    source: item.metadata?.source || 'unknown',\n    detected_language: item.detectedLanguage,\n    memory_id: item.memoryId\n  }\n};\n\ntry {\n  const res = await fetch(heartbeatEventUrl, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify(eventPayload)\n  });\n  console.log(`[WF5-B] üö® needs_support alert sent | status=${res.status}`);\n  return { json: { ...item, alertSent: true } };\n} catch(e) {\n  console.error('[WF5-B] Alert send failed:', e.message);\n  return { json: { ...item, alertSent: false, alertError: e.message } };\n}"
      },
      "id": "9be4325b-f370-4ed5-bdad-d95cb7216fd2",
      "name": "Emit Alert to Heartbeat",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1392,
        160
      ]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\nconsole.log(`[WF5-B] ‚úÖ Done | routing=${item.routing} | stage=${item.growthStage} | logged=${item.logged} | memoryId=${item.memoryId}`);\nreturn { json: { status: 'ok', routing: item.routing, stage: item.growthStage } };"
      },
      "id": "de9a6c68-2b3c-4c57-a6fb-21c84b0239ae",
      "name": "Silent End",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1392,
        320
      ]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\nconsole.log('[WF5-B] Skipped:', item.reason);\nreturn { json: { status: 'skipped', reason: item.reason } };"
      },
      "id": "0158e5df-aae6-4c29-808e-8b61b1402140",
      "name": "Skip End",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        720,
        400
      ]
    }
  ],
  "connections": {
    "Gating Queue Entry": {
      "main": [
        [
          {
            "node": "Validate & Guard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate & Guard": {
      "main": [
        [
          {
            "node": "Should Process?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Process?": {
      "main": [
        [
          {
            "node": "Process Gating",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip End",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Gating": {
      "main": [
        [
          {
            "node": "Log to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log to DB": {
      "main": [
        [
          {
            "node": "Needs Support Alert?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Support Alert?": {
      "main": [
        [
          {
            "node": "Emit Alert to Heartbeat",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Silent End",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Emit Alert to Heartbeat": {
      "main": [
        [
          {
            "node": "Silent End",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "autoActivate": true,
    "instanceId": "c3a8077648ce894608db1ade94831096370fb6a0453430d193f6c81b3c8cc1cb"
  }
}
