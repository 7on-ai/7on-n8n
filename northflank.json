{
  "apiVersion": "v1.2",
  "spec": {
    "kind": "Workflow",
    "spec": {
      "type": "sequential",
      "steps": [
        {
          "ref": "project",
          "kind": "Project",
          "spec": {
            "name": "Sunday-${args.id}",
            "description": "N8N SaaS Instance - Version 1.103.2",
            "color": "#ea4b70",
            "networking": {
              "allowedIngressProjects": [],
              "hostAliases": {
                "enabled": false
              }
            },
            "region": "asia-southeast"
          }
        },
        {
          "kind": "Workflow",
          "spec": {
            "context": {
              "projectId": "${refs.project.id}"
            },
            "type": "sequential",
            "steps": [
              {
                "ref": "database",
                "kind": "Addon",
                "spec": {
                  "name": "database",
                  "infrastructure": {
                    "architecture": "x86"
                  },
                  "type": "postgresql",
                  "version": "16",
                  "billing": {
                    "deploymentPlan": "nf-compute-20",
                    "storageClass": "ssd",
                    "storage": 4096,
                    "replicas": 1
                  }
                }
              },
              {
                "ref": "secrets",
                "kind": "SecretGroup",
                "spec": {
                  "type": "secret",
                  "secretType": "environment-arguments",
                  "priority": 10,
                  "name": "secrets",
                  "addonDependencies": [
                    {
                      "addonId": "${refs.database.id}",
                      "keys": [
                        {
                          "keyName": "INTERNALHOST",
                          "aliases": []
                        },
                        {
                          "keyName": "INTERNALPORT",
                          "aliases": []
                        },
                        {
                          "keyName": "USERNAME",
                          "aliases": []
                        },
                        {
                          "keyName": "PASSWORD",
                          "aliases": []
                        }
                      ]
                    }
                  ],
                  "secrets": {
                    "variables": {
                      "DB_TYPE": "postgresdb",
                      "DB_POSTGRESDB_DATABASE": "n8n",
                      "DB_POSTGRESDB_HOST": "${refs.database.internalHost}",
                      "DB_POSTGRESDB_PORT": "${refs.database.internalPort}",
                      "DB_POSTGRESDB_USER": "${refs.database.username}",
                      "DB_POSTGRESDB_PASSWORD": "${refs.database.password}",
                      "N8N_HOST": "${args.id}.workflow.7on.ai",
                      "N8N_EDITOR_BASE_URL": "https://${args.id}.workflow.7on.ai",
                      "WEBHOOK_URL": "https://${args.id}.workflow.7on.ai",
                      "N8N_ENCRYPTION_KEY": "${fn.randomSecret(32)}",
                      "N8N_RUNNERS_ENABLED": "true",
                      "N8N_RUNNERS_MODE": "internal",
                      "N8N_PROXY_HOPS": "1",
                      "TINI_SUBREAPER": "1",
                      "USER_ID": "${args.user_id}",
                      "USER_EMAIL": "${args.user_email}",
                      "USER_NAME": "${args.user_name}",
                      "SETUP_WEBHOOK_URL": "${args.webhook_url}",
                      "N8N_USERNAME": "${args.user_email}",
                      "N8N_PASSWORD": "${fn.randomSecret(16)}",
                      "N8N_BASE_URL": "https://${args.id}.workflow.7on.ai",
                      "N8N_USER_ID": "${args.user_id}",
                      "N8N_USER_EMAIL": "${args.user_email}",
                      "N8N_USER_NAME": "${args.user_name}",
                      "N8N_USER_PASSWORD": "${fn.randomSecret(16)}",
                      "WORKFLOW_TEMPLATES": "default",
                      "NORTHFLANK_PROJECT_ID": "${refs.project.id}",
                      "NORTHFLANK_PROJECT_NAME": "${refs.project.name}",
                      "N8N_SERVICE_URL": "https://${args.id}.workflow.7on.ai",
                      "ACTUAL_N8N_URL": "https://${args.id}.workflow.7on.ai"
                    },
                    "files": {},
                    "dockerSecretMounts": {}
                  },
                  "restrictions": {
                    "restricted": false,
                    "nfObjects": [],
                    "tags": []
                  }
                }
              },
              {
                "ref": "n8n_service",
                "kind": "DeploymentService",
                "spec": {
                  "name": "n8n",
                  "infrastructure": {
                    "architecture": "x86"
                  },
                  "billing": {
                    "deploymentPlan": "nf-compute-100-2"
                  },
                  "deployment": {
                    "type": "deployment",
                    "instances": 1,
                    "external": {
                      "imagePath": "docker.n8n.io/n8nio/n8n:1.103.2"
                    },
                    "metadata": {
                      "labels": {},
                      "annotations": {}
                    }
                  },
                  "autoscaling": {
                    "horizontal": {
                      "enabled": true,
                      "minReplicas": 1,
                      "maxReplicas": 3,
                      "cpu": {
                        "enabled": true,
                        "thresholdPercentage": 80
                      },
                      "memory": {
                        "enabled": true,
                        "thresholdPercentage": 80
                      }
                    }
                  },
                  "loadBalancing": {
                    "mode": "leastConnection"
                  },
                  "ports": [
                    {
                      "name": "app",
                      "internalPort": 5678,
                      "protocol": "HTTP",
                      "public": true,
                      "security": {
                        "credentials": [],
                        "policies": [],
                        "sso": {}
                      }
                    }
                  ],
                  "healthChecks": [
                    {
                      "protocol": "HTTP",
                      "type": "startupProbe",
                      "port": 5678,
                      "path": "/healthz",
                      "initialDelaySeconds": 30,
                      "periodSeconds": 15,
                      "timeoutSeconds": 10,
                      "failureThreshold": 10
                    },
                    {
                      "protocol": "HTTP",
                      "type": "livenessProbe",
                      "port": 5678,
                      "path": "/healthz",
                      "initialDelaySeconds": 30,
                      "periodSeconds": 60,
                      "timeoutSeconds": 10,
                      "failureThreshold": 3
                    },
                    {
                      "protocol": "HTTP",
                      "type": "readinessProbe",
                      "port": 5678,
                      "path": "/healthz/readiness",
                      "initialDelaySeconds": 30,
                      "periodSeconds": 60,
                      "timeoutSeconds": 10,
                      "failureThreshold": 3,
                      "successThreshold": 1
                    }
                  ],
                  "runtimeEnvironment": {
                    "secretGroups": "secrets"
                  }
                }
              },
              {
                "ref": "setup-job",
                "kind": "ManualJob",
                "spec": {
                  "name": "n8n-setup",
                  "runOnSourceChange": "never",
                  "backoffLimit": 3,
                  "activeDeadlineSeconds": 900,
                  "infrastructure": {
                    "architecture": "x86"
                  },
                  "billing": {
                    "deploymentPlan": "nf-compute-20"
                  },
                  "deployment": {
                    "storage": {
                      "ephemeralStorage": {
                        "storageSize": 1024
                      },
                      "shmSize": 64
                    },
                    "docker": {
                      "configType": "default"
                    },
                    "external": {
                      "imagePath": "ghcr.io/7on-ai/7on-n8n:latest"
                    }
                  },
                  "runtimeEnvironment": {
                    "secretGroups": "secrets"
                  },
                  "buildConfiguration": {
                    "pathIgnoreRules": [],
                    "isAllowList": false,
                    "ciIgnoreFlagsEnabled": false
                  },
                  "buildArguments": {}
                }
              },
              {
                "kind": "JobRun",
                "spec": {
                  "jobId": "${refs.setup-job.id}"
                },
                "condition": "success",
                "ref": "setup-job-run"
              }
            ]
          }
        }
      ]
    }
  },
  "name": "Sunday",
  "description": "n8n Version 1.103.2",
  "options": {
    "autorun": false,
    "concurrencyPolicy": "allow",
    "runOnUpdate": false
  },
  "gitops": {
    "repoUrl": "https://github.com/7on-ai/7on-n8n",
    "vcsService": "github",
    "accountLogin": "7on-ai",
    "branch": "main",
    "filePath": "/northflank.json"
  },
  "$schema": "https://api.northflank.com/v1/schemas/template"
}